{
  "test_id": "test_token_analysis_ultimas_facturas",
  "category": "integration",
  "name": "Token Analysis - √öltimas Facturas (Consulta General)",
  "description": "Valida el sistema de conteo de tokens para consultas generales que deber√≠an encontrar pocas facturas y activar an√°lisis detallado",
  "priority": "medium",
  "tags": ["token-analysis", "general-query", "recent-invoices", "format-validation"],
  "query": "dame las √∫ltimas 5 facturas",
  "expected_behavior": {
    "should_execute_search": true,
    "should_activate_prevention": false,
    "expected_tool": "search_invoices (general) o similar",
    "context_status": "SAFE",
    "estimated_invoices": "~5",
    "estimated_tokens": "~1250-2500"
  },
  "validations": [
    {
      "type": "invoices_found",
      "description": "Debe encontrar facturas recientes (activa TOKEN ANALYSIS)",
      "success_patterns": [
        "Se encontr(√≥|aron)|facturas.*encontradas|\\d+.*facturas"
      ],
      "failure_patterns": [
        "No se encontr|0 facturas"
      ]
    },
    {
      "type": "download_options",
      "description": "Debe incluir opciones de descarga para las facturas encontradas",
      "success_patterns": [
        "descarga|PDF|ZIP|http|enlace"
      ]
    },
    {
      "type": "detailed_invoice_info",
      "description": "Debe incluir informaci√≥n detallada de las facturas",
      "success_patterns": [
        "Cliente|Empresa|RUT|Nombre|Fecha"
      ]
    },
    {
      "type": "token_analysis_logs",
      "description": "Debe activar el logging detallado de an√°lisis de tokens (verificar en logs del servidor)",
      "log_patterns": [
        "\\[TOKEN ANALYSIS - INPUT_DATA\\]",
        "\\[TOKEN ANALYSIS - FINAL_RESPONSE\\]",
        "\\[TOKEN COUNTER\\] Contados \\d+ tokens oficiales",
        "üìä.*\\[PERF LOG\\].*token_analysis"
      ]
    },
    {
      "type": "realistic_metrics",
      "description": "Las m√©tricas de tokens deben ser realistas para pocas facturas",
      "validation_notes": [
        "5 facturas deber√≠a resultar en ~1,250-2,500 tokens total",
        "Tokens por factura: ~250-500 promedio",
        "Uso de contexto: < 1% del l√≠mite de 1M",
        "Estado: SEGURO sin warnings"
      ]
    }
  ],
  "technical_details": {
    "mcp_tool_sequence": [
      "search_invoices o herramienta similar",
      "‚Üí format_enhanced_invoice_response",
      "‚Üí log_token_analysis() con m√©tricas detalladas",
      "‚Üí count_tokens_official() de Vertex AI"
    ],
    "token_validation": {
      "input_data_tokens": "tokens de los datos raw de facturas",
      "output_response_tokens": "tokens de la respuesta formateada final",
      "official_count": "using GenerativeModel.count_tokens()",
      "performance_metrics": "tiempo de formateo, eficiencia"
    },
    "expected_logs": [
      "üîç [TOKEN ANALYSIS - INPUT_DATA]",
      "  üìä Facturas: X",
      "  üî§ Caracteres: X,XXX", 
      "  ü™ô Tokens: X,XXX",
      "  üìà Tokens/factura: XX.X",
      "  üìä Uso contexto: X.X%",
      "  üö¶ Estado: ‚úÖ SEGURO",
      "üîç [TOKEN ANALYSIS - FINAL_RESPONSE]",
      "  (m√©tricas similares para respuesta formateada)",
      "‚úÖ [TOKEN COUNTER] Contados X tokens oficiales",
      "üìä [PERF LOG] {token_analysis: {...}}"
    ]
  },
  "performance": {
    "timeout_seconds": 120,
    "expected_response_time": "< 60s",
    "memory_usage": "low",
    "token_metrics": {
      "expected_range": "1000-5000 tokens",
      "context_usage": "< 1%",
      "tokens_per_invoice": "250-500",
      "format_efficiency": "respuesta formateada vs datos raw"
    }
  },
  "environments": ["local", "staging", "production"],
  "author": "victor-copilot",
  "created_date": "2025-09-12",
  "last_updated": "2025-09-12"
}