{
  "test_id": "test_token_analysis_enero_2024",
  "category": "integration",
  "name": "Token Analysis - Enero 2024 (Mes HistÃ³rico)",
  "description": "Valida el sistema de conteo oficial de tokens en un mes con datos histÃ³ricos reales para comparar estimaciones vs conteo oficial",
  "priority": "medium",
  "tags": ["token-analysis", "historical-data", "vertex-ai-validation", "january-2024"],
  "query": "dame las facturas de enero 2024",
  "expected_behavior": {
    "should_execute_search": true,
    "should_activate_prevention": false,
    "expected_tool": "validate_context_size_before_search â†’ search_invoices_by_month_year",
    "context_status": "SAFE o LARGE_BUT_OK",
    "estimated_invoices": "~100-500 (mes histÃ³rico)",
    "estimated_tokens": "~25000-125000"
  },
  "validations": [
    {
      "type": "search_execution_success",
      "description": "La bÃºsqueda debe ejecutarse sin ser rechazada",
      "success_patterns": [
        "Se encontr(Ã³|aron)|facturas.*encontradas|\\d+.*facturas"
      ],
      "failure_patterns": [
        "demasiado amplia|exceder.*capacidad|refina.*bÃºsqueda"
      ]
    },
    {
      "type": "date_recognition",
      "description": "Debe reconocer correctamente enero 2024",
      "success_patterns": [
        "enero|january|mes.*1|01.*2024",
        "2024"
      ]
    },
    {
      "type": "invoice_information",
      "description": "Debe incluir informaciÃ³n detallada de las facturas encontradas",
      "success_patterns": [
        "factura|Cliente|Empresa|RUT|Nombre",
        "descarga|PDF|ZIP|http|enlace"
      ]
    },
    {
      "type": "token_analysis_activation",
      "description": "Debe activar el anÃ¡lisis de tokens (verificar en logs del servidor ADK)",
      "log_patterns": [
        "\\[TOKEN ANALYSIS - INPUT_DATA\\]",
        "\\[TOKEN ANALYSIS - FINAL_RESPONSE\\]", 
        "\\[TOKEN COUNTER\\] Contados \\d+ tokens oficiales",
        "ðŸ“Š.*Facturas.*Caracteres.*Tokens.*factura"
      ]
    },
    {
      "type": "performance_metrics",
      "description": "Debe generar mÃ©tricas detalladas de performance y contexto",
      "log_patterns": [
        "ðŸ“Š.*Uso contexto.*%",
        "ðŸš¦.*Estado.*SEGURO",
        "ðŸ“ˆ.*Tokens/factura.*\\d+",
        "ðŸ”¤.*Caracteres.*\\d+"
      ]
    }
  ],
  "technical_details": {
    "mcp_tool_sequence": [
      "validate_context_size_before_search (enero 2024)",
      "â†’ COUNT(*) from BigQuery para enero 2024",
      "â†’ estimaciÃ³n: facturas Ã— 250 + 35000 sistema",
      "â†’ context_status: probablemente SAFE/LARGE_BUT_OK",
      "â†’ search_invoices_by_month_year",
      "â†’ format_enhanced_invoice_response",
      "â†’ log_token_analysis() con count_tokens_official()"
    ],
    "token_validation": {
      "mcp_estimation": "~250 tokens por factura (optimizado)",
      "vertex_ai_official": "GenerativeModel.count_tokens() real",
      "performance_target": "estimaciÃ³n debe estar Â±20% del oficial",
      "context_efficiency": "< 15% del lÃ­mite de 1M tokens"
    },
    "expected_logs": [
      "ðŸ” [TOKEN ANALYSIS - INPUT_DATA] con mÃ©tricas de entrada",
      "ðŸ” [TOKEN ANALYSIS - FINAL_RESPONSE] con mÃ©tricas de salida", 
      "âœ… [TOKEN COUNTER] Contados X tokens oficiales",
      "ðŸ“Š Facturas: N",
      "ðŸ”¤ Caracteres: X,XXX",
      "ðŸª™ Tokens: X,XXX",
      "ðŸ“ˆ Tokens/factura: XX.X",
      "ðŸ“Š Uso contexto: XX.X%",
      "ðŸš¦ Estado: âœ… SEGURO"
    ]
  },
  "performance": {
    "timeout_seconds": 300,
    "expected_response_time": "< 120s",
    "memory_usage": "moderate",
    "token_metrics": {
      "expected_range": "25000-125000 tokens",
      "context_usage": "2-12%",
      "tokens_per_invoice": "200-400 average",
      "baseline_comparison": "vs tiktoken estimate (anterior)"
    }
  },
  "environments": ["local", "staging", "production"],
  "author": "victor-copilot",
  "created_date": "2025-09-12", 
  "last_updated": "2025-09-12"
}