# ================================================================
# Invoice Backend - Multi-Service Configuration
# ================================================================
# This configuration file supports multiple services (invoice-backend, 
# invoice-backend-test) using the same codebase with service-specific overrides.
#
# Configuration inheritance:
# 1. Base defaults (this file)
# 2. Environment variables (.env file)
# 3. Service-specific overrides (via SERVICE_NAME env var)
# ================================================================

# ================================================================
# Google Cloud Platform - Dual Project Architecture
# ================================================================
google_cloud:
  # Read Project (Production data - read-only)
  read:
    project: datalake-gasco
    dataset: sap_analitico_facturas_pdf_qa
    bucket: miguel-test
    location: us-central1
    
  # Write Project (Operations, ZIPs, logs - read-write)
  write:
    project: agent-intelligence-gasco
    dataset: zip_operations
    bucket: agent-intelligence-zips
    location: us-central1

  # Service Account Configuration
  service_accounts:
    pdf_signer: adk-agent-sa@agent-intelligence-gasco.iam.gserviceaccount.com
    bigquery_reader: null  # Uses Application Default Credentials
    bigquery_writer: null  # Uses Application Default Credentials

# ================================================================
# BigQuery Tables - Dual Architecture
# ================================================================
bigquery:
  # Timeouts and Performance
  timeouts:
    query_deadline: 60.0  # Retry deadline in seconds for BigQuery queries
    
  # Read tables (datalake-gasco)
  read:
    invoices:
      table: pdfs_modelo
      full_path: datalake-gasco.sap_analitico_facturas_pdf_qa.pdfs_modelo
      
  # Write tables (agent-intelligence-gasco)
  write:
    zip_packages:
      table: zip_packages
      full_path: agent-intelligence-gasco.zip_operations.zip_packages
    logs:
      table: extraction_logs
      full_path: agent-intelligence-gasco.zip_operations.extraction_logs
    operations:
      table: agent_operations
      full_path: agent-intelligence-gasco.zip_operations.agent_operations
    line_items:
      table: invoice_line_items
      full_path: agent-intelligence-gasco.zip_operations.invoice_line_items
    conversation_logs:
      table: conversation_logs
      full_path: agent-intelligence-gasco.chat_analytics.conversation_logs

# ================================================================
# Gasco Business Logic - Field Mapping
# ================================================================
gasco:
  # Field mapping from generic names to Gasco-specific column names
  field_mapping:
    numero_factura: Factura
    solicitante: Solicitante
    factura_referencia: Factura_Referencia
    cliente_rut: Rut
    cliente_nombre: Nombre
    detalles_items: DetallesFactura
    pdf_tributaria_cf: Copia_Tributaria_cf
    pdf_cedible_cf: Copia_Cedible_cf
    pdf_tributaria_sf: Copia_Tributaria_sf
    pdf_cedible_sf: Copia_Cedible_sf
    pdf_termico: Doc_Termico

# ================================================================
# Vertex AI Configuration
# ================================================================
vertex_ai:
  model: gemini-2.5-flash
  temperature: 0.3
  max_workers: 3
  
  # Thinking Mode (Reasoning Budget)
  thinking:
    enabled: false  # Enable for development/debugging
    budget: 1024    # Token budget for reasoning (256-8192)
    max_budget: 8192  # Maximum allowed thinking budget

# ================================================================
# API & Services Configuration
# ================================================================
services:
  # Base configuration (shared across all services)
  defaults:
    port: 8080
    mcp_toolbox_url: http://127.0.0.1:5000
    cloud_run_base_url: https://invoice-backend-819133916464.us-central1.run.app
    
  # Service-specific overrides (selected via SERVICE_NAME env var)
  invoice-backend:
    suffix: ""  # Production service (no suffix)
    cloud_run_url: https://invoice-backend-819133916464.us-central1.run.app
    
  invoice-backend-test:
    suffix: "-test"  # Test service (with suffix)
    cloud_run_url: https://invoice-backend-test-819133916464.us-central1.run.app

# ================================================================
# PDF & ZIP Processing Configuration
# ================================================================
pdf:
  # Signed URLs configuration
  signed_urls:
    expiration_hours: 24
    max_expiration_hours: 168  # Maximum 1 week
    buffer_minutes: 5
    use_robust_implementation: true  # Use clock-skew resistant implementation
    use_solid_implementation: true   # Use SOLID architecture (set to false to rollback to legacy)
    
    # Retry configuration for signature errors
    retry:
      max_retries: 3
      delay_seconds: 2
      backoff_factor: 2.0
      
    # Time synchronization
    time_sync:
      timeout_seconds: 10
      threshold_seconds: 300  # Max acceptable time difference (5 minutes)
      timezone: UTC
      
    # Monitoring
    monitoring:
      enabled: true
      log_level: INFO

  # ZIP packaging configuration
  zip:
    threshold: 5              # Number of invoices to trigger auto-ZIP
    preview_limit: 3          # Number of invoices to preview when ZIP is created
    expiration_days: 7        # Days before ZIP expires
    max_files: 50             # Maximum PDFs per ZIP
    
    # Timeouts
    creation_timeout: 900     # 15 minutes
    download_timeout: 300     # 5 minutes per PDF
    max_concurrent_downloads: 10
    
    # Alternative to ZIP for very large sets
    use_signed_urls_threshold: 30  # Use individual signed URLs instead of ZIP

# ================================================================
# GCS (Google Cloud Storage) Configuration
# ================================================================
gcs:
  # Time Synchronization
  time_sync:
    threshold_seconds: 60  # Max acceptable time difference
    check_timeout: 5       # Timeout for time sync check
  
  # Buffer Time by Clock Skew Status (minutes)
  buffer_time:
    clock_skew_detected: 5      # When clock skew is detected
    verification_failed: 3      # When verification fails
    synchronized: 1             # When time is synchronized
  
  # Retry Logic
  retry:
    max_retries: 3
    base_delay_seconds: 60
    max_delay_seconds: 300
    backoff_multiplier: 2.0
    request_timeout: 30
    jitter_enabled: true
    
    # Error patterns that trigger retry (signature and timeout errors)
    error_patterns:
      - signaturedoesnotmatch
      - signature does not match
      - the request signature we calculated does not match
      - invalid signature
      - expired signature
      - access denied
      - invalid unicode
      - unicodeencodeerror
      - clock skew
      - request time too skewed
      - requesttimetoskewed
      - connection timeout
      - read timeout
      - timed out
    
    # HTTP status codes that are retriable
    retriable_status_codes:
      - 401  # Unauthorized (may be expired signature)
      - 403  # Forbidden (may be signature issue)
  
  # Download Configuration
  download:
    timeout_large_files: 60     # Timeout for large file downloads
    max_concurrent: 10          # Max concurrent downloads
  
  # Monitoring and Metrics
  monitoring:
    enabled: true              # Enable metrics collection
    max_history: 1000          # Max events to keep in history
    log_format: json           # json or text
    
  # Environment Validation
  environment_validation:
    enabled: true              # Validate environment on startup
    check_timezone: true       # Verify UTC timezone
    check_credentials: true    # Verify GCP credentials
    required_env_vars:         # Required environment variables
      - GOOGLE_APPLICATION_CREDENTIALS

# ================================================================
# Validation Limits
# ================================================================
validation:
  max_url_length: 2000          # Maximum URL length in characters
  max_zip_url_length: 3000      # Maximum ZIP URL length
  signature:
    max_length: 500             # Max signature length
    pattern_check_length: 50    # Length for pattern validation

# ================================================================
# Display & UI Configuration
# ================================================================
display:
  max_pdf_links: 10  # Maximum PDF links to show in chat before auto-ZIP

# ================================================================
# System Configuration
# ================================================================
system:
  # Logging Configuration
  log_level: INFO
  debug_mode: false
  
  # Structured Logging (JSON for Cloud Logging)
  logging:
    format: json              # json or text
    level: INFO               # DEBUG, INFO, WARNING, ERROR, CRITICAL
    handlers:
      - console               # Log to console/stdout
      - cloud                 # Cloud Logging compatible
    structured_fields:        # Fields to include in JSON logs
      - timestamp             # ISO 8601 timestamp
      - level                 # Log level
      - logger                # Logger name
      - module                # Module name
      - function              # Function name
      - message               # Log message
      - context               # Additional context data
    disable_emoticons: true   # No emoticons in logs
  
  # Paths (relative to project root)
  paths:
    data: data
    samples: data/samples
    output: invoice_processing_output
    zips: data/zips
  
  # Cloud Run detection
  is_cloud_run: false  # Automatically detected via K_SERVICE env var
  
# ================================================================
# Feature Flags
# ================================================================
features:
  use_robust_signed_urls: true     # Use new stable signed URL implementation
  enable_thinking_mode: false      # Enable model reasoning (development only)
  signed_url_monitoring: true      # Enable signed URL monitoring/logging
  use_legacy_architecture: false   # Fallback to deprecated/legacy code
