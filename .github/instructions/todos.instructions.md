---
applyTo: '**'
---

<todos title="Context Validation Enforcement - Prevent Token Overflow" agentRequirement="Review steps frequently throughout the conversation and DO NOT stop between steps unless they explicitly require it. Keep the todos updated using the todo_write tool (do not edit this file).">
- [x] create-validation-entities: Crear ValidationResult dataclass y ContextStatus enum en src/core/domain/entities/validation.py ✅
  _Campos: context_status (enum), total_facturas, estimated_tokens, recommendation (str), should_block (bool), context_usage_percentage (float). Enum values: SAFE, LARGE_BUT_OK, WARNING_LARGE, EXCEED_CONTEXT._
- [x] implement-context-validation-service: Implementar ContextValidationService con método validate_monthly_search(year, month) ✅
  _Debe llamar MCP tool validate_context_size_before_search y retornar ValidationResult. Si should_block=True, retornar mensaje español al usuario._
- [x] add-validation-config: Agregar sección context_validation en config/config.yaml ✅
  _Config: enforcement_enabled (bool), thresholds (safe_tokens, warning_tokens, max_tokens), message_templates para cada status._
- [x] create-validated-wrapper: Crear wrapper search_invoices_by_month_year_validated() en adk_agent.py ✅
  _Seguir patrón AUTO-ZIP interceptor. Llamar ContextValidationService ANTES de ejecutar tool MCP. Si should_block, retornar error con recommendation._
- [x] register-wrapper-tool: Registrar wrapper como FunctionTool reemplazando MCP tool original ✅
  _En root_agent.tools, filtrar search_invoices_by_month_year de mcp_tools y agregar FunctionTool(search_invoices_by_month_year_validated)._
- [x] add-validation-tests: Crear test script en scripts/validation/test_context_validation.py ✅
  _Tests: validate enero 2025 (high volume), validate mes vacío, validate con enforcement_enabled=false, validate blocking scenario._
</todos>

<!-- 
COMPLETED: Context Validation Enforcement (branch: feature/context-validation-enforcement)
- ✅ create-validation-entities: ValidationResult dataclass, ContextStatus enum
- ✅ implement-context-validation-service: validate_monthly_search, validate_rut_search, validate_date_range_search
- ✅ add-validation-config: context_validation section with thresholds and Spanish messages
- ✅ create-validated-wrapper: search_invoices_by_month_year_validated() interceptor
- ✅ register-wrapper-tool: Filtered mcp_tools, registered FunctionTool wrapper
- ✅ add-validation-tests: test_context_validation.py with 6 tests

COMPLETED: Token Counter Migration - Legacy to SOLID (branch: feature/solid-logging-refinement)
- ✅ create-domain-entities: ConversationRecord, TokenUsage, TextMetrics, ZipPerformanceMetrics
- ✅ implement-conversation-service: 3-strategy extraction, deferred persistence with 30s timeout
- ✅ create-bigquery-repository: Retry policy, Cloud Logging fallback
- ✅ modify-zip-service: Timing metrics, get_last_zip_metrics()
- ✅ integrate-adk-callbacks: before/after_agent_callback registered
- ✅ implement-dual-write: 3 backend modes (legacy/solid/dual), token comparison

COMPLETED: SOLID Logging Refinement (branch: feature/solid-logging-refinement)
- ✅ chore(deps): add pytz for Chile timezone support
- ✅ feat(config): logging configuration with Chile timezone
- ✅ refactor(tracking): standardize logs, daily stats, SIGTERM handler
- ✅ refactor(repository): standardize logs, persistence timing
- ✅ fix(agent): ZIP displayed prominently
- ✅ docs: Cloud Logging queries guide, validation tests
-->
<!-- Add your custom Copilot instructions below -->