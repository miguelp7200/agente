---
applyTo: '**'
---

<todos title="Fix ZIP PDF Type Filtering" agentRequirement="Review steps frequently throughout the conversation and DO NOT stop between steps unless they explicitly require it. Keep the todos updated using the todo_write tool (do not edit this file).">
- [x] add-ntplib-deps: Add ntplib>=0.4.0 to requirements.txt (root and deployment) ðŸ”´
- [x] implement-ntp-hybrid: Extend TimeSyncValidator with NTP hybrid approach (local + HTTP HEAD) ðŸ”´
- [x] create-circuit-breaker: Create CircuitBreaker class with 5/60s threshold, 120s recovery ðŸ”´
- [x] integrate-circuit-breaker: Integrate CircuitBreaker into RobustURLSigner SOLID ðŸ”´
- [x] fix-content-type: Verify content_type NOT included in GET signatures (already correct) ðŸ”´
- [x] uuid-zip-naming: Change ZIP blob names to UUID, add response_disposition for friendly names ðŸ”´
- [x] exclude-signature-retry: Exclude SignatureDoesNotMatch from retry logic (fail fast) ðŸ”´
- [x] add-config-sections: Add NTP and CircuitBreaker config sections to config.yaml ðŸŸ¡
</todos>

---
applyTo: '**'
---

---
applyTo: '**'
---

<!-- 
COMPLETED: Context Validation Enforcement (branch: feature/context-validation-enforcement)
- âœ… create-validation-entities: ValidationResult dataclass, ContextStatus enum
- âœ… implement-context-validation-service: validate_monthly_search, validate_rut_search, validate_date_range_search
- âœ… add-validation-config: context_validation section with thresholds and Spanish messages
- âœ… create-validated-wrapper: search_invoices_by_month_year_validated() interceptor
- âœ… register-wrapper-tool: Filtered mcp_tools, registered FunctionTool wrapper
- âœ… add-validation-tests: test_context_validation.py with 6 tests

COMPLETED: Token Counter Migration - Legacy to SOLID (branch: feature/solid-logging-refinement)
- âœ… create-domain-entities: ConversationRecord, TokenUsage, TextMetrics, ZipPerformanceMetrics
- âœ… implement-conversation-service: 3-strategy extraction, deferred persistence with 30s timeout
- âœ… create-bigquery-repository: Retry policy, Cloud Logging fallback
- âœ… modify-zip-service: Timing metrics, get_last_zip_metrics()
- âœ… integrate-adk-callbacks: before/after_agent_callback registered
- âœ… implement-dual-write: 3 backend modes (legacy/solid/dual), token comparison

COMPLETED: SOLID Logging Refinement (branch: feature/solid-logging-refinement)
- âœ… chore(deps): add pytz for Chile timezone support
- âœ… feat(config): logging configuration with Chile timezone
- âœ… refactor(tracking): standardize logs, daily stats, SIGTERM handler
- âœ… refactor(repository): standardize logs, persistence timing
- âœ… fix(agent): ZIP displayed prominently
- âœ… docs: Cloud Logging queries guide, validation tests
-->
<!-- Add your custom Copilot instructions below -->